<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Banmao Clicker – Pool V1</title>

<!-- Ethers v6 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
<!-- WalletConnect v2 UMD (primary) -->
<script src="https://unpkg.com/@walletconnect/ethereum-provider/dist/umd/index.min.js"></script>

<style>
  :root { --yellow:#ffd84d; }
  html,body{margin:0;background:#0b0b0b;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:20px}
  .card{background:#111;border:1px solid #222;border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-bottom:14px}
  .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .pill{background:#1a1a1a;border:1px solid #222;padding:8px 12px;border-radius:999px}
  .btn{background:var(--yellow);color:#111;border:0;padding:10px 16px;border-radius:12px;font-weight:800;cursor:pointer}
  h1{margin:0 0 10px 0;font-size:22px}
  canvas{width:100%;height:auto;background:#000;border-radius:12px;border:1px solid #222;display:block;cursor:pointer}
  .progress-wrap{margin-top:12px;background:#1a1a1a;border-radius:8px;overflow:hidden;border:1px solid #222}
  .progress-bar{height:20px;background:var(--yellow);width:0%;transition:width 0.2s ease}
  .progress-text{text-align:center;font-size:13px;margin-top:4px;color:#ccc}
  .mobile-banner{display:none;gap:8px;flex-wrap:wrap;margin:10px 0}
  .linkbtn{background:#222;color:#fff;border:1px solid #333;border-radius:999px;padding:6px 10px;font-size:13px;text-decoration:none}
  select.pill{background:#fff;color:#000;font-weight:600;}
  @media(max-width:768px){ .mobile-banner{display:flex;} }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <h1>Banmao Clicker – Pool V1</h1>
      <div>
        <select id="walletSelect" class="pill">
          <option value="auto">Auto (OKX / MetaMask / Trust)</option>
          <option value="okx">Force OKX Wallet</option>
          <option value="metamask">Force MetaMask</option>
          <option value="trust">Force Trust Wallet</option>
          <option value="walletconnect">WalletConnect (QR / Mobile)</option>
          <option value="coinbase">Force Coinbase Wallet</option>
          <option value="rainbow">Force Rainbow</option>
          <option value="bitget">Force Bitget</option>
        </select>
        <button id="connect" class="btn">Connect Wallet</button>
        <button id="claim" class="btn">Claim BANMAO</button>
      </div>
    </div>

    <div class="mobile-banner">
      <span style="opacity:.8">On mobile?</span>
      <a class="linkbtn" href="#" id="openMM">MetaMask</a>
      <a class="linkbtn" href="#" id="openOKX">OKX</a>
      <a class="linkbtn" href="#" id="openTrust">Trust</a>
      <a class="linkbtn" href="#" id="openCBW">Coinbase</a>
      <a class="linkbtn" href="#" id="openRainbow">Rainbow</a>
      <a class="linkbtn" href="#" id="openBitget">Bitget</a>
      <a class="linkbtn" href="#" id="wcQuick">WalletConnect Auto</a>
    </div>

    <div class="row" style="margin-top:-6px;gap:10px">
      <div class="pill">Score: <b id="score">0</b></div>
      <div class="pill">BANMAO earned: <b id="earned">0</b></div>
      <div class="pill">Wallet: <span id="addr">not connected</span></div>
      <div class="pill">Balance: <b id="balance">0</b></div>
      <div class="pill">Status: <span id="status">Ready</span></div>
    </div>

    <canvas id="game" width="900" height="460" style="margin-top:12px"></canvas>

    <div class="progress-wrap"><div id="progressBar" class="progress-bar"></div></div>
    <div id="progressText" class="progress-text">0 / 333 BANMAO</div>
  </div>
</div>

<script>
// =================== GAME (Cat + Banana) ===================
(function(){
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  let score=0; const maxScore=333;
  let banana={x:canvas.width*0.7,y:canvas.height*0.6,dx:2.1,dy:1.7,angle:0};
  let cat={x:160,y:290};

  function drawCat(){
    // head
    ctx.fillStyle='#ffd84d';
    ctx.beginPath();ctx.arc(cat.x,cat.y,62,0,Math.PI*2);ctx.fill();
    // ears
    ctx.beginPath();ctx.moveTo(cat.x-42,cat.y-28);ctx.lineTo(cat.x-12,cat.y-82);ctx.lineTo(cat.x,cat.y-40);ctx.closePath();ctx.fill();
    ctx.beginPath();ctx.moveTo(cat.x+42,cat.y-28);ctx.lineTo(cat.x+12,cat.y-82);ctx.lineTo(cat.x,cat.y-40);ctx.closePath();ctx.fill();
    // face
    ctx.fillStyle='#111';
    ctx.beginPath();ctx.arc(cat.x-20,cat.y-6,7,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(cat.x+20,cat.y-6,7,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.moveTo(cat.x-6,cat.y+8);ctx.lineTo(cat.x+6,cat.y+8);ctx.lineTo(cat.x,cat.y+16);ctx.closePath();ctx.fill();
    ctx.strokeStyle='#111';ctx.lineWidth=2.5;
    ctx.beginPath();ctx.arc(cat.x-8,cat.y+22,8,0,Math.PI,false);ctx.arc(cat.x+8,cat.y+22,8,0,Math.PI,false);ctx.stroke();
    // whiskers
    ctx.beginPath();
    ctx.moveTo(cat.x-28,cat.y+2);ctx.lineTo(cat.x-63,cat.y-8);
    ctx.moveTo(cat.x-28,cat.y+12);ctx.lineTo(cat.x-63,cat.y+12);
    ctx.moveTo(cat.x-28,cat.y+22);ctx.lineTo(cat.x-63,cat.y+32);
    ctx.moveTo(cat.x+28,cat.y+2);ctx.lineTo(cat.x+63,cat.y-8);
    ctx.moveTo(cat.x+28,cat.y+12);ctx.lineTo(cat.x+63,cat.y+12);
    ctx.moveTo(cat.x+28,cat.y+22);ctx.lineTo(cat.x+63,cat.y+32);
    ctx.stroke();
  }

  function drawBanana(){
    ctx.save();
    ctx.translate(banana.x,banana.y);
    ctx.rotate(banana.angle);
    // body
    ctx.beginPath();ctx.lineWidth=26;ctx.strokeStyle='#f1c40f';
    ctx.arc(0,0,42,0.25*Math.PI,1.25*Math.PI);ctx.stroke();
    // thin rim
    ctx.beginPath();ctx.lineWidth=6;ctx.strokeStyle='#d35400';
    ctx.arc(0,0,42,0.25*Math.PI,1.25*Math.PI);ctx.stroke();
    // stalk + tip
    ctx.fillStyle='#d35400';ctx.beginPath();ctx.arc(-32,-28,7,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#f39c12';ctx.beginPath();ctx.arc(36,28,9,0,Math.PI*2);ctx.fill();
    ctx.restore();
  }

  function draw(){
    // subtle grid bg
    ctx.fillStyle='#101010';ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle='#1a1a1a';ctx.lineWidth=1;
    for(let x=0;x<canvas.width;x+=32){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke();}
    for(let y=0;y<canvas.height;y+=32){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke();}
    drawCat();
    drawBanana();
  }

  function update(){
    banana.x+=banana.dx; banana.y+=banana.dy; banana.angle+=0.02;
    if(banana.x>canvas.width-48||banana.x<48) banana.dx*=-1;
    if(banana.y>canvas.height-48||banana.y<48) banana.dy*=-1;
  }

  function loop(){ update(); draw(); requestAnimationFrame(loop); }
  loop();

  function hit(mx,my){ const dx=mx-banana.x, dy=my-banana.y; return Math.hypot(dx,dy) < 56; }
  const scoreEl=document.getElementById('score');
  const earnedEl=document.getElementById('earned');
  const bar=document.getElementById('progressBar');
  const ptxt=document.getElementById('progressText');

  canvas.addEventListener('click',e=>{
    const r=canvas.getBoundingClientRect();
    const mx=(e.clientX-r.left)*(canvas.width/r.width);
    const my=(e.clientY-r.top)*(canvas.height/r.height);
    if(hit(mx,my)){
      score=Math.min(maxScore, score+10);
      scoreEl.textContent=score;
      const earned=score/10; earnedEl.textContent=earned.toFixed(3);
      const pct=Math.min(100,(earned/maxScore)*100); bar.style.width=pct+'%';
      ptxt.textContent=earned.toFixed(3)+" / "+maxScore+" BANMAO";
      // pop
      banana.dx*=1.02; banana.dy*=1.02;
    }
  });
})();

// ================== WALLET CONNECT (MetaMask / OKX / Trust / WalletConnect) ==================
const TOKEN_ADDR = "0x16d91d1615fC55b76d5F92365BD60C069b46ef78";
const GAME_ADDR  = "0x0bb69c08a71e4d2297Fb07f95d2d9c6801937143";
const MAX_BANMAO = 333;
const XLAYER_CHAIN_ID_HEX = "0xC4"; // 196
const WC_PROJECT_ID = "cfda431a5eccf423674b212df85d492c";

const GAME_ABI = [
  "function claimReward(uint256 score) external",
  "function claimed(address) view returns (bool)"
];
const ERC20_ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function decimals() view returns (uint8)"
];

const walletSelect = document.getElementById("walletSelect");
const connectBtn = document.getElementById("connect");
const claimBtn   = document.getElementById("claim");
const addrEl   = document.getElementById("addr");
const balEl    = document.getElementById("balance");
const statusEl = document.getElementById("status");

function isMobile(){ return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent); }

// --- Robust loader for WalletConnect UMD with fallbacks
async function ensureWCLib(){
  if (window.WalletConnectProvider?.EthereumProvider) return true;
  statusEl.textContent = '⏳ Loading WC lib...';
  const sources = [
    'https://unpkg.com/@walletconnect/ethereum-provider/dist/umd/index.min.js',
    'https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider/dist/umd/index.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/walletconnect/2.11.3/ethereum-provider.umd.min.js'
  ];
  for (const src of sources){
    const ok = await new Promise(res=>{
      const s=document.createElement('script');
      s.src=src; s.async=true; s.onload=()=>res(true); s.onerror=()=>res(false);
      document.head.appendChild(s);
    });
    if (ok && window.WalletConnectProvider?.EthereumProvider) return true;
  }
  return false;
}

// Build deeplink targets (exported for tests)
function buildWCLinks(uri){
  const enc = encodeURIComponent(uri);
  return {
    metamaskHttps: `https://metamask.app.link/wc?uri=${enc}`,
    metamask:      `metamask://wc?uri=${enc}`,
    okx:           `okx://wc?uri=${enc}`,
    trustHttps:    `https://link.trustwallet.com/wc?uri=${enc}`,
    trust:         `trust://wc?uri=${enc}`,
    coinbaseHttps: `https://go.cb-w.com/wc?uri=${enc}`,
    coinbase:      `coinbase://wallet/wc?uri=${enc}`,
    rainbowHttps:  `https://rainbow.me/wc?uri=${enc}`,
    rainbow:       `rainbow://wc?uri=${enc}`,
    bitget:        `bitkeep://wc?uri=${enc}`,
    universal:     `https://walletconnect.com/wc?uri=${enc}`
  };
}

function openWalletDeepLink(uri, preferred="metamask"){
  // Cross-browser deeplink helper with multiple fallbacks (Android/iOS + Chrome/Safari/Firefox/Opera/Samsung)
  const links = buildWCLinks(uri);
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

  const openSeq = (arr)=>{
    let i=0; const tryNext=()=>{ if(i>=arr.length) return; const href=arr[i++];
      if (isIOS) { window.location.href = href; setTimeout(tryNext, 900); }
      else {
        try{ window.location.href = href; }catch{}
        setTimeout(()=>{
          const needsIframe = /^(metamask|trust|okx|rainbow|bitkeep|coinbase):\/\//.test(href);
          if(needsIframe){
            const iframe=document.createElement('iframe'); iframe.style.display='none'; iframe.src=href; document.body.appendChild(iframe); setTimeout(()=>iframe.remove(),1200);
          }
          tryNext();
        }, 900);
      }
    }; tryNext();
  };

  if (preferred === 'metamask')      openSeq([links.metamaskHttps, links.metamask, links.universal]);
  else if (preferred === 'okx')      openSeq([links.okx, links.universal]);
  else if (preferred === 'trust')    openSeq([links.trustHttps, links.trust, links.universal]);
  else if (preferred === 'coinbase') openSeq([links.coinbaseHttps, links.coinbase, links.universal]);
  else if (preferred === 'rainbow')  openSeq([links.rainbowHttps, links.rainbow, links.universal]);
  else if (preferred === 'bitget')   openSeq([links.bitget, links.universal]);
  else                               openSeq([links.universal]);
}

async function getWalletConnectProvider(preferred="metamask"){
  const ok = await ensureWCLib();
  if (!ok){ statusEl.textContent = '❌ Không tải được WalletConnect'; alert('WalletConnect lib chưa tải. Vui lòng mở lại trang.'); return null; }
  const provider = await window.WalletConnectProvider.EthereumProvider.init({
    projectId: WC_PROJECT_ID,
    chains: [1], optionalChains: [196], rpcMap: { 196: 'https://rpc.xlayer.tech' },
    showQrModal: !isMobile(),
    metadata: { name:'Banmao Clicker', description:'Claim BANMAO', url: location.origin, icons:['/favicon.ico'] },
    methods:["eth_requestAccounts","eth_sendTransaction","personal_sign","wallet_switchEthereumChain","wallet_addEthereumChain"],
    events:["chainChanged","accountsChanged","disconnect"]
  });
  // important: deeplink as soon as URI is available
  provider.on?.('display_uri', (uri)=>{ if(isMobile()) openWalletDeepLink(uri, preferred); });
  await provider.connect();
  return provider;
}

async function pickInjected(mode){
  // On mobile (or when selecting WalletConnect/other wallets), prefer WalletConnect + deeplink
  if (mode === 'walletconnect' || isMobile() || ['trust','coinbase','rainbow','bitget'].includes(mode))
    return await getWalletConnectProvider(mode);
  const okx = (window.okxwallet?.ethereum || window.okxwallet) || null;
  const mm  = (window.ethereum && window.ethereum.isMetaMask) ? window.ethereum : null;
  const eth = window.ethereum || null; // generic injected
  if (mode==='okx') return okx; if (mode==='metamask') return mm; return okx || mm || eth;
}

async function ensureXLayer(injected){
  try{
    const id = await injected.request({ method:'eth_chainId' });
    if (id === XLAYER_CHAIN_ID_HEX) return;
    await injected.request({ method:'wallet_switchEthereumChain', params:[{ chainId: XLAYER_CHAIN_ID_HEX }] });
  }catch(e){
    if (e?.code===4902 || /Unrecognized|not added/i.test(e?.message||'')){
      await injected.request({ method:'wallet_addEthereumChain', params:[{ chainId: XLAYER_CHAIN_ID_HEX, chainName:'X Layer Mainnet', rpcUrls:['https://rpc.xlayer.tech'], nativeCurrency:{name:'OKB',symbol:'OKB',decimals:18}, blockExplorerUrls:['https://www.oklink.com/xlayer'] }] });
    } else throw e;
  }
}

let provider, signer, account, tokenDecimals=18;

async function updateBalance(){
  try{ if(!provider||!account) return; const token=new ethers.Contract(TOKEN_ADDR, ERC20_ABI, provider); tokenDecimals=await token.decimals(); const bal=await token.balanceOf(account); balEl.textContent=ethers.formatUnits(bal, tokenDecimals); }catch{ balEl.textContent='—'; }
}
async function checkClaimed(){
  try{ if(!provider||!account) return; const game=new ethers.Contract(GAME_ADDR, GAME_ABI, provider); const done=await game.claimed(account); if(done){ statusEl.textContent='✅ Already claimed'; claimBtn.disabled=true; } else { statusEl.textContent='Ready to claim'; claimBtn.disabled=false; } }catch{}
}

connectBtn.addEventListener('click', async ()=>{
  try{
    statusEl.textContent='🔎 Tìm ví...';
    const mode = document.getElementById('walletSelect').value;
    const injected = await pickInjected(mode);
    if(!injected){ statusEl.textContent='No wallet'; alert('Không tìm thấy ví. Dùng WalletConnect hoặc cài extension.'); return; }
    statusEl.textContent='🧾 Yêu cầu quyền...';
    let accounts; try{ accounts = await injected.request?.({ method:'eth_requestAccounts' }); }catch{ accounts = injected.accounts || []; }
    account = (accounts && accounts[0]) || injected.accounts?.[0];
    if(!account){ statusEl.textContent='No account'; return; }
    statusEl.textContent='🔁 Chuyển mạng...';
    try{ await ensureXLayer(injected); }catch{ statusEl.textContent='⚠️ Hãy chuyển sang X Layer (196) trên ví rồi thử lại.'; }
    provider = new ethers.BrowserProvider(injected); signer = await provider.getSigner();
    addrEl.textContent = account.slice(0,6)+'...'+account.slice(-4);
    statusEl.textContent='✅ Connected';
    await updateBalance(); await checkClaimed();
  }catch(err){ console.error('CONNECT_ERR',err); statusEl.textContent='❌ '+(err?.shortMessage||err?.message||err); }
});

// Quick buttons (mobile)
const openMM     = document.getElementById('openMM');
const openOKX    = document.getElementById('openOKX');
const openTrust  = document.getElementById('openTrust');
const openCBW    = document.getElementById('openCBW');
const openRainbow= document.getElementById('openRainbow');
const openBitget = document.getElementById('openBitget');
const wcQuickBtn = document.getElementById('wcQuick');
openMM?.addEventListener('click', async (e)=>{ e.preventDefault(); await getWalletConnectProvider('metamask'); });
openOKX?.addEventListener('click', async (e)=>{ e.preventDefault(); await getWalletConnectProvider('okx'); });
openTrust?.addEventListener('click', async (e)=>{ e.preventDefault(); await getWalletConnectProvider('trust'); });
openCBW?.addEventListener('click', async (e)=>{ e.preventDefault(); await getWalletConnectProvider('coinbase'); });
openRainbow?.addEventListener('click', async (e)=>{ e.preventDefault(); await getWalletConnectProvider('rainbow'); });
openBitget?.addEventListener('click', async (e)=>{ e.preventDefault(); await getWalletConnectProvider('bitget'); });
wcQuickBtn?.addEventListener('click', async (e)=>{ e.preventDefault(); await getWalletConnectProvider('metamask'); });

claimBtn.addEventListener('click', async ()=>{
  try{
    if(!signer) return alert('Connect wallet first!');
    const banmaoNow = score/10; if (banmaoNow < 1) return alert('Need at least 1 BANMAO to claim!');
    const amount = Math.min(MAX_BANMAO, Math.floor(banmaoNow));
    const game = new ethers.Contract(GAME_ADDR, GAME_ABI, signer);
    const tx = await game.claimReward(amount);
    statusEl.textContent='⏳ Tx: '+tx.hash; claimBtn.disabled=true; await tx.wait();
    statusEl.textContent='✅ Claim succeeded ('+amount+' BANMAO)'; await updateBalance(); await checkClaimed();
  }catch(e){ statusEl.textContent='❌ '+(e?.shortMessage||e?.reason||e?.message||e); claimBtn.disabled=false; }
});

// =================== SELF TESTS (non-intrusive) ===================
(function selfTests(){
  const results=[]; const log=(name, ok, detail='')=>{ const tag=ok?'PASS':'FAIL'; console.log(`[SelfTest] ${tag} ${name}`, detail); };
  try{ const links=buildWCLinks('wc:test');
       const ok = links.metamaskHttps.includes('wc%3Atest') && links.metamask.startsWith('metamask://');
       log('buildWCLinks', ok, links); } catch(e){ log('buildWCLinks', false, e); }
  try{ log('getWalletConnectProvider exists', typeof getWalletConnectProvider==='function'); } catch(e){ log('getWalletConnectProvider exists', false, e); }
  try{ log('connect button exists', !!document.getElementById('connect')); } catch(e){ log('connect button exists', false, e); }
})();
</script>

</body>
</html>