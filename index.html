<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Banmao Clicker ‚Äì Pool V1</title>

<!-- Ethers v6 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
<!-- WalletConnect UMD -->
<script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.12.0/dist/umd/index.min.js"></script>

<style>
  :root { --yellow:#ffd84d; }
  html,body{margin:0;background:#0b0b0b;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:20px}
  .card{background:#111;border:1px solid #222;border-radius:18px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-bottom:14px}
  .row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .pill{background:#1a1a1a;border:1px solid #222;padding:8px 12px;border-radius:999px}
  .btn{background:var(--yellow);color:#111;border:0;padding:10px 16px;border-radius:12px;font-weight:800;cursor:pointer}
  h1{margin:0 0 10px 0;font-size:22px}
  canvas{width:100%;height:auto;background:#000;border-radius:12px;border:1px solid #222;display:block;cursor:pointer}
  .progress-wrap{margin-top:12px;background:#1a1a1a;border-radius:8px;overflow:hidden;border:1px solid #222}
  .progress-bar{height:20px;background:var(--yellow);width:0%;transition:width 0.2s ease}
  .progress-text{text-align:center;font-size:13px;margin-top:4px;color:#ccc}
  .mobile-banner{display:none;gap:8px;flex-wrap:wrap;margin:10px 0}
  .linkbtn{background:#222;color:#fff;border:1px solid #333;border-radius:999px;padding:6px 10px;font-size:13px;text-decoration:none}
  select.pill{background:#fff;color:#000;font-weight:600;}
  @media(max-width:768px){ .mobile-banner{display:flex;} }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <h1>Banmao Clicker ‚Äì Pool V1</h1>
      <div>
        <select id="walletSelect" class="pill">
          <option value="auto">Auto (OKX / MetaMask / Trust)</option>
          <option value="okx">Force OKX Wallet</option>
          <option value="metamask">Force MetaMask</option>
          <option value="trust">Force Trust Wallet</option>
          <option value="walletconnect">WalletConnect (QR / Mobile)</option>
        </select>
        <button id="connect" class="btn">Connect Wallet</button>
        <button id="claim" class="btn">Claim BANMAO</button>
      </div>
    </div>

    <div class="row" style="margin-top:-6px;gap:10px">
      <div class="pill">Score: <b id="score">0</b></div>
      <div class="pill">BANMAO earned: <b id="earned">0</b></div>
      <div class="pill">Wallet: <span id="addr">not connected</span></div>
      <div class="pill">Balance: <b id="balance">0</b></div>
      <div class="pill">Status: <span id="status">Ready</span></div>
    </div>

    <canvas id="game" width="900" height="460" style="margin-top:12px"></canvas>

    <div class="progress-wrap"><div id="progressBar" class="progress-bar"></div></div>
    <div id="progressText" class="progress-text">0 / 333 BANMAO</div>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const isMobile = ()=>/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

// Game
(function(){
  const canvas=$('game');const ctx=canvas.getContext('2d');
  let score=0;const MAX=333;
  const state={banana:{x:canvas.width*0.7,y:canvas.height*0.5,vx:2,vy:2,angle:0},cat:{x:160,y:300}};
  function bg(){ctx.fillStyle='#101010';ctx.fillRect(0,0,canvas.width,canvas.height);} 
  function cat(){const{x,y}=state.cat;ctx.fillStyle='#ffd84d';ctx.beginPath();ctx.arc(x,y,60,0,Math.PI*2);ctx.fill();}
  function banana(){const b=state.banana;ctx.save();ctx.translate(b.x,b.y);ctx.rotate(b.angle);ctx.strokeStyle='#f1c40f';ctx.lineWidth=20;ctx.beginPath();ctx.arc(0,0,40,0.25*Math.PI,1.25*Math.PI);ctx.stroke();ctx.restore();}
  function update(){const b=state.banana;b.x+=b.vx;b.y+=b.vy;b.angle+=0.02;if(b.x<40||b.x>canvas.width-40) b.vx*=-1;if(b.y<40||b.y>canvas.height-40) b.vy*=-1;}
  function loop(){update();bg();cat();banana();requestAnimationFrame(loop);} loop();
  canvas.addEventListener('click',e=>{const r=canvas.getBoundingClientRect();const mx=(e.clientX-r.left)*(canvas.width/r.width);const my=(e.clientY-r.top)*(canvas.height/r.height);const dx=mx-state.banana.x,dy=my-state.banana.y;if(Math.hypot(dx,dy)<50){score=Math.min(MAX,score+10);$('score').textContent=score;$('earned').textContent=(score/10).toFixed(3);$('progressBar').style.width=Math.min(100,(score/10)/MAX*100)+'%';$('progressText').textContent=(score/10).toFixed(3)+' / 333 BANMAO';window.__banmaoScore=score;}});
})();

// Wallet connect (simplified)
$('connect').addEventListener('click',async()=>{
  try{
    if(window.ethereum){
      await window.ethereum.request({method:'eth_requestAccounts'});
      const accs=await window.ethereum.request({method:'eth_accounts'});
      if(accs.length){$('addr').textContent=accs[0];$('status').textContent='‚úÖ Connected';}
    }else{
      $('status').textContent='‚ùå No wallet';
    }
  }catch(e){$('status').textContent='‚ùå '+e.message;}
});
// ===== WalletConnect helpers for mobile (OKX focus) =====
const WC_PROJECT_ID = 'cfda431a5eccf423674b212df85d492c';
function okxDeepLinks(uri){
  const enc = encodeURIComponent(uri);
  return [
    `intent://wc?uri=${enc}#Intent;scheme=okx;package=com.okinc.okex.gp;S.browser_fallback_url=https%3A%2F%2Fwalletconnect.com%2Fwc%3Furi%3D${enc};end`,
    `okx://wc?uri=${enc}`,
    `https://walletconnect.com/wc?uri=${enc}`
  ];
}
let __dlWin = null;
function launchOKX(uri){
  const seq = okxDeepLinks(uri);
  const nav = (href)=>{
    try{ if(__dlWin && !__dlWin.closed){ __dlWin.location.href = href; } else { location.href = href; } }
    catch{ location.href = href; }
  };
  let i=0; (function step(){ if(i>=seq.length) return; nav(seq[i++]); setTimeout(step, 900); })();
}
async function ensureWC(){
  if (window.WalletConnectProvider?.EthereumProvider) return true;
  return new Promise(res=>{
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.12.0/dist/umd/index.min.js';
    s.onload=()=>res(!!window.WalletConnectProvider?.EthereumProvider);
    s.onerror=()=>res(false);
    document.head.appendChild(s);
  });
}
async function connectWithWalletConnectOKX(){
  const ok = await ensureWC();
  if(!ok){ $('status').textContent='‚ùå WalletConnect unavailable'; return null; }
  const provider = await window.WalletConnectProvider.EthereumProvider.init({
    projectId: WC_PROJECT_ID,
    chains:[196], // X Layer on OKX
    rpcMap:{196:'https://rpc.xlayer.tech'},
    showQrModal: !isMobile(),
    metadata:{ name:'Banmao Clicker', description:'Connect to claim', url: location.origin, icons:['/favicon.ico'] },
    methods:["eth_requestAccounts","wallet_switchEthereumChain","wallet_addEthereumChain"],
    events:["display_uri","accountsChanged","chainChanged","disconnect"]
  });
  provider.on?.('display_uri', (uri)=>{ if(isMobile()){ $('status').textContent='üîó Opening OKX...'; launchOKX(uri); } });
  await provider.connect();
  return provider;
}

// ===== Connect button (injected on desktop, WC on mobile/OKX) =====
$('connect').addEventListener('click', async()=>{
  try{
    $('status').textContent='üîé Connecting...';
    let injected=null;
    if(!isMobile() && window.ethereum){
      injected = window.ethereum; // desktop MetaMask/OKX extension
    } else {
      try{ __dlWin = window.open('', '_blank'); }catch{}
      injected = await connectWithWalletConnectOKX();
    }
    if(!injected){ $('status').textContent='‚ùå Wallet not found'; try{__dlWin?.close();}catch{} return; }
    // request accounts
    const accounts = await (injected.request ? injected.request({method:'eth_requestAccounts'}) : injected.enable?.());
    const account = (Array.isArray(accounts)?accounts[0]: (injected.accounts?.[0]||null));
    if(!account){ $('status').textContent='‚ùå No account'; try{__dlWin?.close();}catch{} return; }
    // show address
    $('addr').textContent = account;
    $('status').textContent = '‚úÖ Connected';
    try{__dlWin?.close();}catch{}
  }catch(e){ $('status').textContent='‚ùå '+(e?.message||e); try{__dlWin?.close();}catch{} }
});
</script>
</body>
</html>
